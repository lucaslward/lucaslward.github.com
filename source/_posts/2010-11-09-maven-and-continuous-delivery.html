---
layout: post
title: "Maven and Continuous Delivery"
date: 2010-11-09T21:30:00-08:00
comments: false
---

<div class='post'>
There has been an interesting discussion going on recently in the Maven user group list about Continuous Delivery:<a href="http://maven.40175.n5.nabble.com/Continuous-Delivery-and-Maven-td3245370.html"><br /><br />http://maven.40175.n5.nabble.com/Continuous-Delivery-and-Maven-td3245370.html</a><br /><br />My colleague here at ThoughtWorks, <a href="http://www.jezhumble.net/">Jez Humble,</a> contends that the SNAPSHOT model that Maven uses is prohibitive to many of the principles espoused in his <a href="http://www.continousdelivery.com/">book</a>.  And I have to say, I largely agree with him.<br /><br />Before diving into why I agree with him, it's worthwhile to add a bit of context.  I'm one of a minority of people in ThoughtWorks that prefer Maven to Ant.  That's not to say that we don't deliver projects using Maven, but if given a choice, most ThoughtWorkers prefer Ant.  Personally, I have had a long history of using Maven, starting with my work with <a href="http://static.springsource.org/spring-batch/">Spring Batch</a>.  That's not to say that Maven doesn't have it's problems, but if given a choice, I'll start a project with Maven.  (Why that's the case would certainly be worthy of another blog post)  I mention all of this because I am not bringing up issues with the release model of Maven to bash it because I hate the tool.  I bring it up because I think there can be improvements in how Maven thinks about and deals with releases.<br /><br />I remember the first time I had to cut a release with Maven oh so many years ago. I had my project working, everything was in exactly the state I wanted it to be into for release.  All I needed to do was create the final cut.  Like a good Maven user, I went to check out the documentation for how Maven approached releases.  I quickly found the section on the release plugin and thought 'Aha, I just need to use this plugin, and my release will be painless, thanks Maven!'  Of course, reality is never that simple.  The maven release project has two 'phases' prepare, and then the actual release.  Below is a list of what Maven does during the prepare phase, shamelessly pulled from the <a href="http://maven.apache.org/plugins/maven-release-plugin/examples/prepare-release.html">official plugin site</a>:<br /><ul><li>Check that there are no uncommitted changes in the sources</li><li>Check that there are no SNAPSHOT dependencies</li><li>Change the version in the POMs from x-SNAPSHOT to a new version (you will be prompted for the versions to use)</li><li>Transform the SCM information in the POM to include the final destination of the tag</li><li>Run the project tests against the modified POMs to confirm everything is in working order</li><li>Commit the modified POMs</li><li>Tag the code in the SCM with a version name (this will be prompted for)</li><li>Bump the version in the POMs to a new value y-SNAPSHOT (these values will also be prompted for)</li><li>Commit the modified POMs</li></ul>The SCM related bits make sense.  Of course you need to create a tag that coincides with the release.  However, the majority of the remaining bullets are around modifications to the POM files themselves, and checking that other POM files aren't in a 'SNAPSHOT' state.<br /><br />I didn't understand that process years ago, and I still don't understand it today.  I have my codebase, I've tested it thoroughly, both with unit, integration, automated, and manually testing. I just want to take the 'binary' that I've been using, and promote it to production while also taging the SCM revision that created it.  Why does a snapshot state even matter?  I suppose with external dependencies there are some concerns about APIs changing underneath you.  However, what does it matter, you have working code, right now, surely the changing API is a problem for tomorrow, not the release of today?<br /><br />In my time at ThoughtWorks, and other consulting experience, I have always prognosticated that the same build that a developer makes on his machine, and ultimately what will come out of CI (because he or she commits that revision) should look as identical as possible to what will be in production.  Why add an extra step to change anything at all?<br /><br />In short, I agree with Jez, why can't every artifact created from mvn deploy be potentially a release into production?  The only value I've seen the snapshot concept add is away to describe a dependency as 'whatever the latest CI has produced is'.  It seems to me its just as easy to say: 'any release greater than x.y' and call it a day, which is something Maven supports now as well, at least from a dependency declaration perspective.</div>
<h2>Comments</h2>
<div class='comments'>
<div class='comment'>
<div class='author'>Danijel Arsenovski</div>
<div class='content'>
@dantheperson <br />Exactly.<br /><br />Finally, you can always NOT use snapshots. If the team works on the same artifact, no need to use snapshot mechanism to update the binaries anyway and the current project will be updated through code repository. Dependencies can be updates through mvn versions:display-dependency-updates.</div>
</div>
<div class='comment'>
<div class='author'>dantheperson</div>
<div class='content'>
<i>However, what does it matter, you have working code, right now, surely the changing API is a problem for tomorrow, not the release of today?</i><br /><br />Snapshots changing beneath you is a problem for tomorrow, but it&#39;s a problem you need to solve today.<br /><br />So you&#39;ve released 1.1.1 and a couple days later a critical bug is discovered and you need to do an emergency intra-day release.<br /><br />Work on trunk has continued on features that are user visible and you don&#39;t want to release them till the next regular release after the end users have been notified of the changes.<br /><br />No problem, just create a branch from your 1.1.1 release tag, fix the bug, and build 1.1.2 right?  <br /><br />Not if you have snapshot dependencies, because when you checkout the source and build, it pulls down the latest snapshot dependencies which are going to be newer than the one you pulled in last week, which might not compile, or even worse will have subtle bugs that only show up during the exhaustive testing that you don&#39;t have time to give to this emergency patch release.<br /><br />So as your builds aren&#39;t repeatable with snapshot dependencies, the path you have to take is to start with your last binary distribution, and patch in just the jar you want. And once you&#39;ve done that you&#39;re distributing binary images that you can&#39;t rebuild from source.  Good luck supporting that.</div>
</div>
<div class='comment'>
<div class='author'>Christopher</div>
<div class='content'>
I must say that I followed this thread on the Maven Users list and got a little lost with it. I don&#39;t really understand where Jez is coming from.<br /><br />From my own perspective, I&#39;ve never had an issue with the release plugin. I like how it works; particularly when you have many developers all working on the same thing and you want to take something out of the CI stream at a particular rev and then release it.<br /><br />I wonder if this debate is an academic one, or whether there really was some issue Jez came across to fuel the debate. If it is the latter then it&#39;d be great to hear about what happened in reality.<br /><br />Maybe Thoughtworks should develop a new release plugin also given that I don&#39;t see Maven itself being the issue.</div>
</div>
<div class='comment'>
<div class='author'>Curt Yanko</div>
<div class='content'>
I have never cared for the release plugin either, didn&#39;t make sense to me. Still the idea of transmorgafying your SNAPSHOTS into a *release* is fine if you your not worried about reproducibility. The amount of effort to compensate for that is on the wrong side of an 80/20 equation imo. Sadly, far too many Maven users devolve into using SNAPSHOTS for the wrong reasons, namely laziness. The byproduct of years of neglect for the build process in general as a second class, low value, activity not worthy a a developers attention or time.<br /><br />Ant clearly lends itself to CD because it doen&#39;t try to manage the build dependencies, a simple *.jar in the &#39;ol lib folder will do, thank you very much. And why not? It&#39;s all in there right? ...managed by good &#39;ol SCC tools. But Maven wants you to be more prescriptive about those yet out of old habits many see SNAPSHOTS as the mechanism to keep doing things the old,l easy, way.<br /><br />In Maven, when you have *value* you need to release it (pin it down so-to-speak). Myself and others in that thread did flip the problem around and re-approached it with Dependency ranges in mind which imo provides a much clearer path forward to craft a plugin that can meet the needs of CD. Dependency ranges provide the ease-of-use of SNAPSHOTs but resolve to real, released, versions at build time which can be captured and codified.<br /><br />I&#39;m sure I have a lot to learn about CD but I&#39;m also sure the Maven community will get there.</div>
</div>
<div class='comment'>
<div class='author'>Michael HÃ¼ttermann</div>
<div class='content'>
in my opinion the best approach is: people over processes over tools.<br /><br />Thus Maven&#39;s release plugin can be the best choice in the case your process is exactly what the plugin offers. In other cases, you need to set up an infrastructure that maps to your release process. I agree with Jason, this often is part of the activities of (technical) release management. <br /><br />I like Maven and its concepts. That said, the process of chosing the right tool is aligned with concrete requirements. As a result of this Ant can be the best choice in a specific situation, in other cases it is Maven or something completely different.</div>
</div>
<div class='comment'>
<div class='author'>Jason van Zyl</div>
<div class='content'>
Unfortunately, but naturally, users tend to think that the release plugin embodies all best practices for Maven with respect to releases, but in practice many people accept it&#39;s flaws -- for which there are many -- or remake their own tools.<br /><br />I believe the separation of snapshot and release repositories are required but the extraction of a release should happen as the process of extracting that release from a stream of potential releases. Given you could assert all conditions of the build you should be able to tag the code, and pluck the snapshot out and promote it to a release repository.<br /><br />I don&#39;t think you would have any disagreements with you from a release management perspective. Someone just needs to do the two weeks of work to add the tooling.</div>
</div>
</div>
