---
layout: post
title: "Upgrading Grails 1.3.x to use Hibernate 3.3.2"
date: 2011-03-23T13:19:00-07:00
comments: false
---

<div class='post'>
While using Hibernate Envers, I ran into an issue that was fixed in Hibernate 3.3.2.  Unfortunately, Grails is using Hibernate 3.3.1.  Luckily, it's fairly straightforward to exclude and declare a new dependency in your BuildConfig.groovy:<br /><br /><pre class="prettyprint"><br />inherits("global") {<br /> excludes 'hibernate'<br />}<br />dependencies {<br /> compile ('org.hibernate:hibernate-core:3.3.2.GA'){<br />     excludes 'ehcache', 'xml-apis', 'commons-logging'<br /> }<br />}<br /></pre><span style="font-weight: bold;">Update:</span> turns out it's not as straightforward as I thought.  The above will work fine with 'grails run-app' but the 3.3.1 version will still be in the War file: <a href="http://www.lucasward.net/2011/03/excluding-jars-from-grails-generated.html">http://www.lucasward.net/2011/03/excluding-jars-from-grails-generated.html</a> You can fix that by adding the following to your BuildConfig.groovy:<br /><br /><pre class="prettyprint"><br />grails.war.resources = { stagingDir -><br /> delete(file:"${stagingDir}/WEB-INF/lib/hibernate-core-3.3.1.GA.jar")<br />}<br /></pre><br /><br />Unfortunately, in the 3.3.2 release, "“org.hibernate.dialect.DialectFactory” was moved to “org.hibernate.dialect.resolve.DialectFactory”.  Which was part of the following issue: <a href="http://opensource.atlassian.com/projects/hibernate/browse/HHH-2933">http://opensource.atlassian.com/projects/hibernate/browse/HHH-2933</a><br /><br />This is apparently an issue many have been seeing: <a href="http://grails.1312388.n4.nabble.com/update-hibernate-version-td3002449.html">http://grails.1312388.n4.nabble.com/update-hibernate-version-td3002449.html</a><br /><br />While it may seem crazy that the Hibernate team moved something to a new package in a point release.  I'm pretty sure they consider this class to be internal and not part of their API.  The issue the change was made in was to expose to users a way to resolve their own dialects programmatically.  Which, if you look at where the Grails Hibernate plugin is creating the offending spring bean, is the same thing Grails is doing:<br /><br /><pre class="prettyprint"><br />if (ds &amp;&amp; ds.dialect) {<br />  if (ds.dialect instanceof Class) {<br />      hibProps."hibernate.dialect" = ds.dialect.name<br />  }<br />  else {<br />      hibProps."hibernate.dialect" = ds.dialect.toString()<br />  }<br />}<br />else {<br />  dialectDetector(HibernateDialectDetectorFactoryBean) {<br />      dataSource = ref("dataSource")<br />      vendorNameDialectMappings = vendorToDialect<br />   }<br />   hibProps."hibernate.dialect" = dialectDetector<br />}<br /></pre><br /><br />The above is taken from HibernatePluginSupport.groovy, line 128. (At least in Grails 1.3.6)  Essentially they've written a Spring bean to programmatically determine the dialect by calling the DialectFactory themselves.  You can bypass this issue completely by specifying your dialect, rather than having it detected.  If you're using mysql, it looks something like:<br /><br /><pre class="prettyprint"><br />dataSource {<br />driverClassName = "com.mysql.jdbc.Driver"<br />dialect = "org.hibernate.dialect.MySQLDialect"<br />}<br /></pre></div>
<h2>Comments</h2>
<div class='comments'>
<div class='comment'>
<div class='author'>Lucas Ward</div>
<div class='content'>
I&#39;ll see if I can dig for the issue I found that was causing issues in Envers.  I also wrote a plugin as well that I haven&#39;t had a time to post.  I&#39;ll be pushing it to github within the next couple of days.</div>
</div>
<div class='comment'>
<div class='author'>stephen westfall</div>
<div class='content'>
Can you provide any details on the Envers issue that triggered this upgrade?  I&#39;m trying to use Envers on a Grails project and having issues.</div>
</div>
</div>
