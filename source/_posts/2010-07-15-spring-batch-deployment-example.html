---
layout: post
title: "Spring Batch Deployment Example"
date: 2010-07-15T14:14:00-07:00
comments: false
---

<div class='post'>
Deployment has always been a tricky part of Batch Processing.  Unlike a Web application, there is no standardized deployment, and there are a variety of environments that could be deployed to.  You could actually deploy a Batch application within a web container, or as a standalone java app to be started by one of many available schedulers.  For this reason, everyone's environment is different, and there can be no one example that someone can use as a starting point.  However, I have done enough standalone deployments for Linux using Bash to share a simple example. <br /><br />The job itself matters little for the purposes of this post.  A simple one tasklet job suffice:<br /><br /><pre class="prettyprint">   &lt;job id="sampleJob" job-repository="jobRepository"&gt;<br />       &lt;step id="simpleStep"&gt;<br />           &lt;tasklet ref="tasklet" /&gt;<br />       &lt;/step&gt;<br />   &lt;/job&gt;<br /><br />   &lt;beans:bean id="jobRepository" <br />   class="org.springframework.batch.core.repository.support.MapJobRepositoryFactoryBean"/&gt;<br /><br />   &lt;beans:bean id="transactionManager" <br />   class="org.springframework.batch.support.transaction.ResourcelessTransactionManager" /&gt;<br /><br />   &lt;beans:bean id="jobLauncher" <br />   class="org.springframework.batch.core.launch.support.SimpleJobLauncher"&gt;<br />       &lt;beans:property name="jobRepository" ref="jobRepository" /&gt;<br />   &lt;/beans:bean&gt;<br /><br />   &lt;beans:bean id="tasklet" class="net.lucasward.sample.SampleTasklet" /&gt;<br /></pre><br /><br />(namespace removed for readability)<br /><br />The Tasklet simply prints 'Hello World'<br /><br /><pre class="prettyprint">public class SampleTasklet implements Tasklet {<br /><br />   public RepeatStatus execute(StepContribution contribution, <br />                               ChunkContext chunkContext) throws Exception {<br />       System.out.println("Hello World");<br />       return FINISHED;<br />   }<br />}<br /></pre><br /><br />Simple enough, right?  Now for the hard part.  If we want a scheduler to be able to launch this from the command line, what do we do?  The first problem to solve is, what does our deployment look like?  In my mind, there's three necessary components: <br /><br /><ol><br /><li>The jars themselves, which need to be on the classpath<br /></li><li>A Script that can be called<br /></li><li>The xml and/or .properties files that will be used for configuration<br /></li></ol><br /><br />Personally, I prefer to separate the XML files from the jars, to allow for tweaks to the Job.  This is especially useful for Spring Batch job definitions, although may be less so for normal spring configuration files.   My preferred layout is to have three directories: bin, lib, and resources.  Obviously, the scripts go in /bin, jars in /lib, and xml/properties in /resources.  It doesn't really matter how you break yours up, but it's the format I'll be using.  In order to create this layout, I'll use Maven and the assembly plugin:<br /><br /><pre><br />          &lt;plugin&gt;<br />               &lt;artifactId&gt;maven-assembly-plugin&lt;/artifactId&gt;<br />               &lt;version&gt;2.2-beta-2&lt;/version&gt;<br />               &lt;configuration&gt;<br />                   &lt;descriptors&gt;<br />                       &lt;descriptor&gt;src/main/assembly/descriptor.xml&lt;/descriptor&gt;<br />                   &lt;/descriptors&gt;<br />               &lt;/configuration&gt;<br />               &lt;executions&gt;<br />                   &lt;execution&gt;<br />                       &lt;id&gt;make-distribution&lt;/id&gt;<br />                       &lt;phase&gt;package&lt;/phase&gt;<br />                       &lt;goals&gt;<br />                           &lt;goal&gt;single&lt;/goal&gt;<br />                       &lt;/goals&gt;<br />                   &lt;/execution&gt;<br />               &lt;/executions&gt;<br />           &lt;/plugin&gt;<br /></pre><br /><br />And the Descriptor:<br /><br /><pre>&lt;assembly&gt;<br />   &lt;id&gt;distribution&lt;/id&gt;<br />   &lt;formats&gt;<br />       &lt;format&gt;tar.gz&lt;/format&gt;<br />   &lt;/formats&gt;<br />   &lt;includeBaseDirectory&gt;false&lt;/includeBaseDirectory&gt;<br />   &lt;fileSets&gt;<br />       &lt;fileSet&gt;<br />           &lt;directory&gt;src/main/scripts&lt;/directory&gt;<br />           &lt;outputDirectory&gt;bin&lt;/outputDirectory&gt;<br />           &lt;useDefaultExcludes&gt;true&lt;/useDefaultExcludes&gt;<br />       &lt;/fileSet&gt;<br />       &lt;fileSet&gt;<br />           &lt;directory&gt;src/main/resources&lt;/directory&gt;<br />           &lt;outputDirectory&gt;resources&lt;/outputDirectory&gt;<br />           &lt;useDefaultExcludes&gt;true&lt;/useDefaultExcludes&gt;<br />           &lt;filtered&gt;true&lt;/filtered&gt;<br />       &lt;/fileSet&gt;<br />   &lt;/fileSets&gt;<br /><br />   &lt;dependencySets&gt;<br />       &lt;dependencySet&gt;<br />           &lt;outputDirectory&gt;lib&lt;/outputDirectory&gt;<br />       &lt;/dependencySet&gt;<br />   &lt;/dependencySets&gt;<br />&lt;/assembly&gt;<br /></pre><br /><br />The format I'm using is tar.gz, since I'm targeting linux, but <a href="http://maven.apache.org/plugins/maven-assembly-plugin/">there are many more available</a>.<br /><br />The two fileset entries describes both the bin and resources directory.  (I haven't talked about the script yet, but I will below).  The 'DependencySet' reference is to transfer all the dependencies that Maven is managing into the lib directory, including the created jar itself.  When you run 'mvn install' there will be two artifacts created: The normal jar, and another file with the same name, ending in -distribution.tar.gz.  In the case of my example that is: batch-deploy-sample-1.0-SNAPSHOT.jar and batch-deploy-sample-1.0-SNAPSHOT-distribution.tar.gz.  In my example, unzipping gave me the following:<br /><br /><pre>./bin:<br />sampleJob.sh<br /><br />./lib:<br />aopalliance-1.0.jar                           spring-batch-core-2.1.1.RELEASE.jar           spring-tx-2.5.6.jar<br />batch-deploy-sample-1.0-SNAPSHOT.jar          spring-batch-infrastructure-2.1.1.RELEASE.jar stax-1.2.0.jar<br />commons-logging-1.1.1.jar                     spring-beans-2.5.6.jar                        stax-api-1.0.1.jar<br />jettison-1.1.jar                              spring-context-2.5.6.jar                      xpp3_min-1.1.4c.jar<br />spring-aop-2.5.6.jar                          spring-core-2.5.6.jar                         xstream-1.3.jar<br /><br />./resources:<br />jobs<br /><br />./resources/jobs:<br />sampleJob.xml<br /></pre><br /><br />All we need now is a simple script to actually run the job:<br /><br /><pre class="prettyprint">#!/bin/bash<br /><br />CP=resources/<br /><br />LIB=lib/*<br />for f in $LIB<br />do<br />CP=$CP:$f<br />done<br /><br />java -cp $CP org.springframework.batch.core.launch.support.CommandLineJobRunner \<br />jobs/sampleJob.xml sampleJob<br /></pre><br /><br />I'm probably not going to win any awards for my bash scripting skills anytime soon, but it gets the job done and isn't quite as archaic as a more concise version would be.  Essentially, I'm creating a classpath from all the jar files in /lib by looping through the files and separating them with a colon.  Once that is done, I can start a java process, using the <a href="http://static.springsource.org/spring-batch/apidocs/org/springframework/batch/core/launch/support/CommandLineJobRunner.html">CommandLineJobRunner</a> as the Main method.  As described in the documentation, all I need to pass to the job runner is the xml file to run the job, and the job name.  (It's worth noting that normally you would also need JobParameters, but since I'm using the MapRepository, it isn't necessary)<br /><br />You can download the running example from my github account: <a href="http://github.com/lucaslward/blog/tree/master/batch-deploy-sample/">batch-deploy-sample</a>.</div>
<h2>Comments</h2>
<div class='comments'>
<div class='comment'>
<div class='author'>Lucas Ward</div>
<div class='content'>
Interesting. I&#39;ll definitely add your code for the script directory. I&#39;m not a big fan of using the CLASSPATH variable, so I think I&#39;ll stick to just passing in the classpath to the command line via -cp</div>
</div>
<div class='comment'>
<div class='author'>Philippe</div>
<div class='content'>
I slightly corrected the shell script so that it can be launched from anywhere, rather than having to cd to the bin directory.<br />Here is what I did :<br /><br /># Set the classpath<br />SCRIPTDIR=&quot;$( cd &quot;$( dirname &quot;$0&quot; )&quot; &amp;&amp; pwd )&quot;<br />CLASSPATH=.<br /><br />for file in `ls $SCRIPTDIR/../lib`<br />do<br />        export CLASSPATH=$CLASSPATH:$SCRIPTDIR/../lib/$file<br />done<br />export CLASSPATH=$CLASSPATH:$SCRIPTDIR:$SCRIPTDIR/../resources<br /><br /># Launch the conversion job<br />java org.springframework.batch.core.launch.support.CommandLineJobRunner ...</div>
</div>
<div class='comment'>
<div class='author'>Philippe</div>
<div class='content'>
Thanks a lot ! It&#39;s exactly what I was looking for and it works like a charm...</div>
</div>
<div class='comment'>
<div class='author'>Philippe</div>
<div class='content'>
This comment has been removed by the author.</div>
</div>
<div class='comment'>
<div class='author'>Dil.............................................:)</div>
<div class='content'>
I want to stop the running spring batch job, Please let me know how can i do that .. i wil b follooing u r blog fr ans</div>
</div>
<div class='comment'>
<div class='author'>Lucas Ward</div>
<div class='content'>
I&#39;m sorry for the crazy late response, I&#39;ve been extremely busy with client work for the last few weeks.  Are you still having this issue?</div>
</div>
<div class='comment'>
<div class='author'>David Tam</div>
<div class='content'>
Thanks, this is very useful for someone totally new to Spring Batch, but when I run the job.. I get this.. <br /><br />ClassPathXmlApplicationContext [INFO] Refreshing org.springframework.context.support.ClassPathXmlApplicationContext@4ca31e1b: display name [org.springframework.context.support.ClassPathXmlApplicationContext@4ca31e1b]; startup date [Fri Oct 22 10:28:52 CDT 2010]; root of context hierarchy<br />2010-10-22 10:28:52 XmlBeanDefinitionReader [INFO] Loading XML bean definitions from class path resource [jobs/sampleJob.xml]<br />2010-10-22 10:28:53 CommandLineJobRunner [ERROR] Job Terminated in error:<br />org.springframework.beans.factory.BeanDefinitionStoreException: Unexpected exception parsing XML document from class path resource [jobs/sampleJob.xml]; nested exception is java.lang.IllegalArgumentException: &#39;beanName&#39; must not be empty<br /><br />Its probably something simple I&#39;m missing.</div>
</div>
</div>
